#!/bin/sh

ScriptName=${0}
BaseName=$(basename ${ScriptName})
DirName=$(dirname $(readlink -f ${ScriptName}))
CommandName="${DirName}/${BaseName}3.py"
SYSTEMCTL="${DirName}/systemctl3.py"
LOGFILE="$PREFIX/var/log/journal/systemd-journald.service.log"

no_sudo_commands="-h --help --version cat command default-services \
                   environment get-default get-preset help is-enabled \
                   list-dependencies list-start-dependencies list-unit-files \
                   listen log"

out() { printf "$1 $2\n" "${@:3}"; }
error() { out "$@"; } >&2
msg() { out "==>" "$@"; }
msg2() { out "  ->" "$@";}
die() { error "$@"; exit 1; }

ignore_error() {
  "$@" 2>/dev/null
  return 0
}

mklinksv(){
  for service in $PREFIX/var/service/*/ ;do
    service=$(basename ${service})
    [ -e "$PREFIX/lib/systemd/system/sv%N.service" ] && ignore_error ln -sn sv%N.service "$PREFIX/lib/systemd/system/$service.service"
    [ -e "../sv/$service/current" ] && ln -sf "../sv/$service/current" "$PREFIX/var/log/journal/$service.service.log"
  done
}

log_msg(){
  echo "$(date +'%b %d %T') $(hostname) $(basename ${0})[$$]: ${@}"
}

log_msg_run(){
  log_msg ${@}
  ${@}
}

sudo_systemctl(){
  if [ "$(id -u)" -eq 0 ] || [ -n "${TERMUX_VERSION}" ] ; then
    command=${SYSTEMCTL}
  elif which_sudo="$(which sudo)" ; then
    command="${which_sudo} ${SYSTEMCTL}"
  else
    error "\033[0;31mFailed to ${@}: Interactive authentication required.\033[0m"
    command=${SYSTEMCTL}
  fi
}

systemctl() {
  [ -z "$1" ] || ! echo "${no_sudo_commands}" | grep -qw "$1" && sudo_systemctl "$@"
  control "$@"
}

control(){
  [ -z "$command" ] && command=${CommandName}
  [ ! -x /usr/bin/python3 ] && command="termux-chroot ${command}"
  $command ${@}
}

init(){
  log_msg_run mount -a -v
  systemctl init
}

umount_a(){
  log_msg Umounting all filesystems mentioned in fstab
  tac /etc/fstab | while read line; do
    if [ "$(echo "$line" | cut -c1)" != "#" ]; then
      dest=$(echo "$line" | awk '{print $2}')
      [ -e "$dest" ] && [ -n "$dest" ] && log_msg_run umount -lr "$dest"
    fi
  done
  mount -a -v
  log_msg Umounted all filesystems mentioned in fstab
}

halt(){
  # log_msg_run umount_a
  systemctl halt
}

mklinksv

case ${BaseName} in
  journalctl)
    control ${@}
    ;;
  init)
    init
    ;;
  halt)
    halt
    ;;
  reboot)
    halt&&init
    ;;
  *)
    # die "${BaseName}: applet not found"
    systemctl ${@}
    ;;
esac